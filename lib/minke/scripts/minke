#!/bin/bash
MINKE_VERSION="1.13.8"
    
DOCKER_SOCK="/var/run/docker.sock:/var/run/docker.sock"
NEW_UUID=$(base64 /dev/urandom | tr -d '/+' | head -c 32 | tr '[:upper:]' '[:lower:]')
          
DOCKER_IMAGE="minketester"
              
COMMAND=$*
                 
GEM_VOLUMES=""
                   
# Test if we need to mount any special volumes for paths specified in the Gemfile
while read -r line; do
  l=$(echo $line | sed "s/.*:path *=> *//" | sed "s/['|\"]\(.*\)['|\"]/\1/")
  GEM_VOLUMES="${GEM_VOLUMES} -v $l:$l"
  done < <(grep :path Gemfile)
                       
  if [[ $1 != \generate* ]]; then
    DIR=$(dirname `pwd`)
    DOCKER_RUN="docker run --rm ${IT} -it --net=minke_${NEW_UUID} ${GEM_VOLUMES} -v ${DOCKER_SOCK} -v ${DIR}:${DIR} -v ${DIR}/_build/vendor    :/usr/local/bundle -e DOCKER_NETWORK=minke_${NEW_UUID} -w ${DIR}/_build ${DOCKER_IMAGE} ${COMMAND}"
                             
    echo "Running command: minke ${COMMAND}"
                               
    eval "docker network create minke_${NEW_UUID}"
    eval "${DOCKER_RUN}"
    eval "docker network rm minke_${NEW_UUID}"
  fi
